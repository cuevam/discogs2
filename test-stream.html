<!DOCTYPE html>
<html>
<head>
    <title>API Test</title>
</head>
<body>
    <h1>Discogs API Stream Test</h1>
    <button onclick="testStream()">Test Stream</button>
    <div id="output" style="margin-top: 20px; font-family: monospace; white-space: pre;"></div>

    <script>
        async function testStream() {
            const output = document.getElementById('output');
            output.textContent = 'Starting request...\n';

            try {
                const response = await fetch('http://localhost:3001/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream',
                    },
                    body: JSON.stringify({
                        styles: ['Krautrock'],
                        pageDelayMs: 1000,
                        sort: 'listed,desc'
                    })
                });

                output.textContent += `Response status: ${response.status}\n`;
                output.textContent += `Headers: ${JSON.stringify([...response.headers])}\n\n`;

                if (!response.body) {
                    output.textContent += 'No response body!';
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let itemCount = 0;
                let buffer = '';

                output.textContent += 'Reading stream...\n';

                while (true) {
                    output.textContent += 'Waiting for chunk...\n';
                    const { done, value } = await reader.read();
                    
                    output.textContent += `Got chunk: done=${done}, bytes=${value?.length || 0}\n`;
                    
                    if (done) {
                        output.textContent += '\nStream completed!';
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            if (data.type === 'progress') {
                                output.textContent += `Progress: Page ${data.currentPage}/${data.totalPages}, ${data.itemsLoaded} items\n`;
                            } else if (data.type === 'data') {
                                itemCount++;
                                if (itemCount % 10 === 0) {
                                    output.textContent += `Received ${itemCount} items...\n`;
                                }
                            } else if (data.type === 'complete') {
                                output.textContent += `\nComplete! Total items: ${itemCount}\n`;
                            } else if (data.type === 'error') {
                                output.textContent += `ERROR: ${data.message}\n`;
                            }
                        } else if (line.startsWith(':')) {
                            output.textContent += 'Connection keepalive received\n';
                        }
                    }
                }
            } catch (error) {
                output.textContent += `\nError: ${error.message}\n${error.stack}`;
            }
        }
    </script>
</body>
</html>
